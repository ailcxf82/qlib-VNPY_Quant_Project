新建一个投资多策略rqalpha回测的脚本，把总资产分成 2 份（可配置比例,未来有可能增加更多策略，目前先按2份配置），每份给一个子策略
选股小市值策略1：
按模型预测结果ktop获取CSI101小市值股票池预测前20只股票
通过tushare api排除排除科创/北交（代码前缀 68、4、8 等）排除停牌、ST、名称含 ST/*/退 排除上市不足 360 天的次新股 
盈利 + PB正常 + 审计正常的股票，选中前6只股票，同行业最多持有2只股票，周频等权持有
每周1调仓一次，每日检查持仓涨停卖出，并且运行按当前小市值股票池选股策略1，补充卖出后的空缺，使持仓股票数保持在6只

选股低估值策略2：
按模型预测结果ktop获取CSI300小市值股票池预测前20只股票
通过tushare api 过滤近 5 日内“涨停过”的股票 0 < PB < 1：典型“低估值/破净”风格，盈利为正，用 ROA 做质量排序（ROA 越高越优）近 2 年出现“非正常审计意见”的剔除
最后也就是候选只保留 Top2（ROA 最高的两个低PB盈利股）
每周1日调仓一次，每日检查持仓涨停卖出，并且运行按当前低估值选股策略2，补充卖出后的空缺，使持仓股票数保持在4只

通用的回测逻辑：
每日收盘前30分钟监听股票状态，持仓股票回撤需要小于8%，否则卖出，并且运行当前策略，补充卖出后的空缺，使持仓股票数保持在策略规定的数量
0) 目标与基准（先定清楚）
目标：最大回撤优先，其次夏普
建议基准：沪深300（偏稳）或中证500（偏弹）。多头增强更常用 300/500/全A 之一。
风控的核心指标：

最大回撤（MDD）
年化波动（Vol）
夏普（Sharpe）
换手率（Turnover）与成本占比（Cost / Gross P··做硬过滤（能显著降低尾部风险和滑点）：建议默认过滤条件（可按资金体量微调）：
剔除：ST/*ST、退市整理、长期停牌、重大异常波动标的（你可用交易所标签）
价格过滤：股价 < 3 元剔除（减少“壳/极端波动”风险）
流动性过滤：近20日日均成交额 ADV20 ≥ 5000万（30万资金够用，门槛不必太高）
交易状态过滤：当日涨跌停、开盘一字板、临停等（至少在下单逻辑上“不可买/不可卖”要有保护）
财务雷简化过滤（如果你能拿到）：连续亏损/审计意见异常/高质押等做黑名单（哪怕很粗也值）

A股尾部回撤很多来自：流动性差 + 事件雷 + 涨跌停导致无法退出。过滤能立刻改善回撤分布。
2) 组合构建：用“分散 + 暴露约束”换回撤对于30万、日频，多头增强我建议：
持股数：20–40 只（低于20容易集中回撤，高于40换手成本更难控）
单票权重上限：3%–5%（默认 4%）
单行业上限：20%–25%（默认 25%）
小市值暴露限制：别让组合市值暴露极端偏小盘（A股风格切换时回撤会很难看）
如果你做得起“约束优化”（哪怕是启发式/贪心），建议加两类软/硬约束：
行业中性/行业偏离限制：组合行业权重不偏离基准太多
β约束：组合对基准的 ‘β‘`\beta`‘β‘ 不要长期 > 1.1（多头增强想要更稳，建议接近1或略低）
3) 仓位控制：波动率目标 + 回撤关仓（最关键）3.1 波动率目标（Vol Targeting）设定一个你能接受的组合年化波动目标，比如 10%–12%（偏稳，夏普更容易做出来）。用组合近20日/60日的实现波动估计 ‘σ^‘`\hat{\sigma}`‘σ^‘，仓位系数：wvol=min⁡(1, σtargetσ^)w_{\text{vol}} = \min\left(1,\ \frac{\sigma_{\text{target}}}{\hat{\sigma}}\right)wvol​=min(1, σ^σtarget​​)
‘σtarget‘`\sigma_{\text{target}}`‘σtarget​‘：0.10～0.12
‘σ^‘`\hat{\sigma}`‘σ^‘：用组合日收益标准差 × ‘252‘`\sqrt{252}`‘252​‘
3.2 回撤分层降仓（Drawdown Controller）用“阶梯式”更稳、更符合实盘执行。例子（你可按风格调阈值）：
回撤 < 3%：‘wdd=1.0‘`w_{\text{dd}}=1.0`‘wdd​=1.0‘
3%–6%：‘wdd=0.7‘`w_{\text{dd}}=0.7`‘wdd​=0.7‘
6%–10%：‘wdd=0.4‘`w_{\text{dd}}=0.4`‘wdd​=0.4‘


10%：‘wdd=0.15‘`w_{\text{dd}}=0.15`‘wdd​=0.15‘ 并进入冷静期（例如5个交易日只允许减仓不加仓）


最终总仓位：w=wvol⋅wdd⋅wregimew = w_{\text{vol}} \cdot w_{\text{dd}} \cdot w_{\text{regime}}w=wvol​⋅wdd​⋅wregime​
这套机制对“最大回撤”非常直接；你会明显看到回撤尾巴变短，夏普通常也会改善（因为波动降了）。
4) 市场状态（Regime）开关：让你在不利环境少暴露日频多头增强，建议至少用一个简单的 趋势 + 广度/恐慌 组合信号做 ‘wregime‘`w_{\text{regime}}`‘wregime​‘。一个可落地的默认版本（不追求预测，只求避险）：
趋势：基准指数收盘价在60日均线之上 → 风险开；之下 → 风险收
恐慌/波动：如果近20日指数波动或“跌停家数/下跌家数占比”显著上升 → 降风险
例如：
风险开：‘wregime=1.0‘`w_{\text{regime}}=1.0`‘wregime​=1.0‘
风险中：‘wregime=0.7‘`w_{\text{regime}}=0.7`‘wregime​=0.7‘
风险关：‘wregime=0.4‘`w_{\text{regime}}=0.4`‘wregime​=0.4‘（甚至更低）

A股的回撤很多发生在“趋势破位 + 广度恶化”的阶段，用这种简单开关往往比复杂模型更可靠。
5) 交易成本与换手：夏普的隐形杀手你用的是日频 + 多模型stack，天然容易“信号抖动→高换手→成本吃掉收益”。建议硬约束：
组合日换手上限：10%–20%（默认 15%）
交易成本回测参数别太乐观：

双边千分之 0.8～1.5（含佣金+滑点，按你的通道调）
冲击成本可按成交额/波动做增量（哪怕简化也比不做强）


同时做两个工程化处理：
信号平滑：对预测分数做 3–5 日 EMA 或者 rank 的滑动融合，减少无意义来回切换
阈值交易：只有当新权重与旧权重差异超过阈值（如 0.3%–0.5%）才交易
6) 个股层面的“灾难保护”A股的个股尾部风险不小，但T+1与跌停又让止损不总能执行，所以核心是事前规避 + 仓位上限：
单票上限（前面已给）：默认 4%
高波动个股降权：用个股近20日波动对权重做惩罚（类似风险平价的思想）
事件风险黑名单：公告密集期、重大诉讼、业绩暴雷高发标签（能取到就做）

与其做“10%止损”，不如把高雷/高波动标的限制在组合里“死也死不大”。
7) 对冲/保护（可选，取决于你是否能用衍生品）30万资金不一定都方便做期货；给你两套版本：7.1 无衍生品版本（更普适）
风险关时：降仓 + 提高现金/货基比例
或者把一部分仓位切换到 宽基ETF（降低个股尾部）
7.2 可用ETF期权/股指期货版本（更强的尾部保护）
小比例“买保险”：用宽基ETF Put 做灾难保险（预算型，比如每月花组合净值的 0.2%–0.5%）
或用股指期货做β对冲（需要资格与保证金管理），重点是控制基差与保证金压力
8) 一套“默认参数模板”（你可以直接用来跑回测/实盘）
持股：30只
单票上限：4%
行业上限：25%
ADV20过滤：≥ 5000万
目标年化波动：11%
回撤降仓：3%/6%/10% 四档（1.0/0.7/0.4/0.15）+ 冷静期5天
Regime：指数在60日均线下且广度恶化 → ‘wregime=0.4‘`w_{\text{regime}}=0.4`‘wregime​=0.4‘
日换手上限：15%
交易阈值：权重变化 < 0.4% 不交易
成本假设：双边 1‰（起步），并做敏感性：0.8‰/1.2‰/1.5‰ 三档
9) 针对你“LightGBM + MLP + Stack”的一句关键建议你最在意回撤和夏普时，模型输出不要直接当“买卖指令”，而是当“排序信号”，再用上面的 约束+仓位控制器 去落地。
很多多头增强回撤失控，原因不是模型方向错，而是暴露与仓位没关住 + 换手成本失真。