# 增强特征集应用指南

## 一、概述

本指南说明如何充分利用您提供的完整行业参数，构建更强大的特征集。

### 可用数据字段

| 字段 | 类型 | 说明 | 用途 |
|------|------|------|------|
| `open` | float | 开盘点位 | 价格特征 |
| `low` | float | 最低点位 | 价格特征 |
| `high` | float | 最高点位 | 价格特征 |
| `close` | float | 收盘点位 | 价格特征 |
| `change` | float | 涨跌点位 | 价格特征 |
| `pct_change` | float | 涨跌幅 | 价格特征（更准确） |
| `vol` | float | 成交量（万股） | 量能特征 |
| `amount` | float | 成交额（万元） | 量能特征 |
| `pe` | float | 市盈率 | 估值特征 |
| `pb` | float | 市净率 | 估值特征 |
| `float_mv` | float | 流通市值（万元） | 市值特征 |
| `total_mv` | float | 总市值（万元） | 市值特征 |

---

## 二、特征工程策略

### 2.1 特征分类

#### 1. 价格动量特征（7个）

**设计思路**：
- 使用 `pct_change` 作为最准确的1日收益率
- 多时间尺度捕捉不同周期的动量效应
- 使用 `change` 构建相对变化特征

```yaml
- "$pct_change"                    # 1日涨跌幅（最准确）
- "$close / Ref($close, 5) - 1"    # 5日收益率
- "$close / Ref($close, 10) - 1"   # 10日收益率
- "$close / Ref($close, 20) - 1"   # 20日收益率
- "$close / Ref($close, 60) - 1"   # 60日收益率
- "$close / Ref($close, 120) - 1"  # 120日收益率
- "$change / $close"              # 涨跌点位相对收盘价
```

**关键点**：
- `pct_change` 通常比手动计算更准确（考虑了复权等因素）
- 多时间尺度捕捉短期反转、中期动量、长期趋势

#### 2. 价格波动特征（7个）

**设计思路**：
- 使用 `high` 和 `low` 构建振幅特征
- 捕捉日内波动和价格形态

```yaml
- "Std($pct_change, 10)"           # 10日波动率
- "Std($close / Ref($close, 1) - 1, 20)"   # 20日波动率
- "Std($close / Ref($close, 1) - 1, 60)"   # 60日波动率
- "($high - $low) / $close"        # 日内振幅
- "($high - $low) / Ref($high - $low, 1)"  # 振幅变化率
- "($close - $open) / $close"       # 实体相对收盘
- "($close - $open) / ($high - $low + 1e-12)"  # 实体相对振幅
```

**关键点**：
- 振幅特征反映市场情绪和交易活跃度
- 实体比例反映多空力量对比

#### 3. 量能特征（10个）

**设计思路**：
- 充分利用 `vol`（成交量）和 `amount`（成交额）
- 构建量能趋势、价量关系特征

```yaml
# 成交量特征
- "Log($vol + 1)"                  # 对数成交量
- "$vol / Ref($vol, 5) - 1"        # 5日成交量变化率
- "$vol / Ref($vol, 20) - 1"       # 20日成交量变化率
- "$vol / Mean($vol, 20) - 1"      # 成交量相对20日均量
- "$vol / Mean($vol, 60) - 1"      # 成交量相对60日均量

# 成交额特征
- "Log($amount + 1)"               # 对数成交额
- "$amount / Ref($amount, 5) - 1"  # 5日成交额变化率
- "$amount / Ref($amount, 20) - 1" # 20日成交额变化率
- "$amount / ($vol + 1e-12)"       # 平均成交价格
- "Corr($pct_change, $vol / Ref($vol, 1) - 1, 20)"  # 价量相关性
```

**关键点**：
- 成交额 = 成交量 × 平均价格，包含更多信息
- 价量相关性反映市场健康度

#### 4. 估值特征（10个）

**设计思路**：
- 使用 `pe`（市盈率）和 `pb`（市净率）
- 构建估值趋势、相对估值特征

```yaml
# 市盈率特征
- "$pe"                            # 原始PE
- "Log($pe + 1)"                   # 对数PE（处理异常值）
- "$pe / Mean($pe, 20) - 1"        # PE相对20日均值
- "$pe / Mean($pe, 60) - 1"        # PE相对60日均值
- "Ref($pe, 1) / $pe - 1"          # PE变化率

# 市净率特征
- "$pb"                            # 原始PB
- "Log($pb + 1)"                   # 对数PB
- "$pb / Mean($pb, 20) - 1"        # PB相对20日均值
- "$pb / Mean($pb, 60) - 1"        # PB相对60日均值
- "$pe / ($pb + 1e-12)"            # PE/PB比率
```

**关键点**：
- 估值特征反映行业相对吸引力
- 相对估值（相对于历史均值）比绝对估值更有意义

#### 5. 市值特征（8个）

**设计思路**：
- 使用 `float_mv`（流通市值）和 `total_mv`（总市值）
- 构建市值趋势、换手率特征

```yaml
# 流通市值特征
- "Log($float_mv + 1)"             # 对数流通市值
- "$float_mv / Ref($float_mv, 5) - 1"   # 5日流通市值变化率
- "$float_mv / Ref($float_mv, 20) - 1"  # 20日流通市值变化率

# 总市值特征
- "Log($total_mv + 1)"            # 对数总市值
- "$total_mv / Ref($total_mv, 5) - 1"   # 5日总市值变化率
- "$total_mv / Ref($total_mv, 20) - 1"  # 20日总市值变化率

# 综合特征
- "$float_mv / ($total_mv + 1e-12)"  # 流通市值占比
- "$amount / ($float_mv + 1e-12)"  # 流通市值换手率
```

**关键点**：
- 市值反映行业规模
- 换手率反映流动性

#### 6. 综合特征（3个）

**设计思路**：
- 跨维度特征，捕捉不同维度之间的关系

```yaml
- "Corr($pct_change, $pe, 20)"      # 收益率与PE的相关性
- "Corr($pct_change, $pb, 20)"     # 收益率与PB的相关性
- "Corr($pct_change, Log($float_mv + 1), 20)"  # 收益率与市值的相关性
```

**关键点**：
- 相关性特征捕捉动态关系
- 反映市场风格切换

---

## 三、特征工程最佳实践

### 3.1 数据预处理

#### 1. 对数变换

**适用场景**：
- 成交量、成交额、市值等具有长尾分布的数据

**原因**：
- 减少极端值影响
- 使数据分布更接近正态分布
- 提高模型稳定性

```yaml
- "Log($vol + 1)"        # +1 避免 log(0)
- "Log($amount + 1)"
- "Log($float_mv + 1)"
```

#### 2. 相对变化率

**适用场景**：
- 所有原始数值特征

**原因**：
- 消除绝对数值的影响
- 关注变化趋势而非绝对水平
- 更适合截面标准化

```yaml
- "$vol / Ref($vol, 5) - 1"        # 5日变化率
- "$pe / Mean($pe, 20) - 1"        # 相对均值
```

#### 3. 截面标准化

**重要性**：⭐⭐⭐⭐⭐

**原因**：
- 行业轮动是相对排序问题
- 消除市场环境影响
- 避免未来数据泄露

**配置**：
```yaml
cross_sectional_normalization:
  enabled: true
  method: "zscore"          # 或 "rank"
  groupby: "datetime"
  clip: true
  clip_quantile: 0.05
```

### 3.2 特征选择建议

#### 优先级1：核心特征（必须使用）

1. **价格动量**：`pct_change`, `ret_5`, `ret_20`, `ret_60`
2. **价格波动**：`std_ret_20`, `amplitude`
3. **量能**：`log_vol`, `vol_chg_20`, `price_vol_corr_20`
4. **估值**：`pe`, `pb`, `pe_ma_ratio_20`
5. **市值**：`log_float_mv`, `turnover_float`

**总计**：约 15-20 个核心特征

#### 优先级2：增强特征（推荐使用）

1. **多时间尺度动量**：`ret_10`, `ret_120`
2. **多窗口波动**：`std_ret_10`, `std_ret_60`
3. **量能趋势**：`vol_ma_ratio_60`, `amount_chg_20`
4. **估值趋势**：`pe_chg`, `pb_ma_ratio_20`
5. **综合特征**：`ret_pe_corr_20`, `ret_mv_corr_20`

**总计**：约 30-40 个特征

#### 优先级3：完整特征集（可选）

- 使用所有 45+ 个特征
- 适合数据充足、计算资源充足的情况

---

## 四、配置文件使用

### 4.1 使用增强配置

在 `config_industry_rotation.yaml` 中：

```yaml
data_config: "classify/config_data_industry_enhanced.yaml"
```

### 4.2 自定义特征集

如果某些字段不可用，可以修改配置文件：

```yaml
features:
  # 如果 pct_change 不可用，使用备用计算
  - "$close / Ref($close, 1) - 1"    # 替代 pct_change
  
  # 如果 pe/pb 不可用，可以注释掉相关特征
  # - "$pe"
  # - "$pb"
```

---

## 五、特征重要性分析

### 5.1 预期重要性排序

根据行业轮动预测的经验，特征重要性大致排序：

1. **价格动量**（最重要）
   - `pct_change`, `ret_20`, `ret_60`
   - 直接反映行业表现

2. **量能特征**
   - `vol_chg_20`, `price_vol_corr_20`
   - 反映市场关注度

3. **估值特征**
   - `pe_ma_ratio_20`, `pb_ma_ratio_20`
   - 反映相对吸引力

4. **市值特征**
   - `turnover_float`
   - 反映流动性

5. **波动特征**
   - `std_ret_20`, `amplitude`
   - 反映风险

### 5.2 特征交互

IndustryGRU 的 Feature Attention 层会自动学习特征重要性，但建议：

1. **避免高度相关特征**：
   - `vol` 和 `amount` 高度相关，可以只用一个
   - `float_mv` 和 `total_mv` 高度相关，可以只用一个

2. **保留互补特征**：
   - `pe` 和 `pb` 互补（不同估值维度）
   - `vol` 和 `amount` 互补（量能的不同角度）

---

## 六、注意事项

### 6.1 数据质量

1. **缺失值处理**：
   - `pe`, `pb` 可能在某些日期缺失（如停牌）
   - 建议使用前向填充或均值填充

2. **异常值处理**：
   - `pe`, `pb` 可能为负值或极大值
   - 使用对数变换或极值裁剪

3. **数据一致性**：
   - 确保所有字段的时间对齐
   - 检查数据更新频率

### 6.2 计算效率

1. **特征数量**：
   - 完整特征集约 45+ 个特征
   - 如果计算资源有限，可以只使用核心特征（15-20个）

2. **滚动窗口计算**：
   - `Corr()`, `Mean()`, `Std()` 等函数需要滚动窗口
   - 建议窗口大小不超过 120 天

### 6.3 模型适配

1. **Feature Attention**：
   - IndustryGRU 会自动学习特征重要性
   - 不需要手动特征选择

2. **截面标准化**：
   - 必须启用，否则特征无法跨时期比较
   - 建议使用 `zscore` 方法

---

## 七、效果预期

### 7.1 相比基线特征集的改进

| 指标 | 基线特征集 | 增强特征集 | 改进 |
|------|-----------|-----------|------|
| 特征数量 | 15 | 45+ | +200% |
| 信息维度 | 价格+量能 | 价格+量能+估值+市值 | +2个维度 |
| 预期 Rank IC | 0.05-0.10 | 0.08-0.15 | +50% |
| 计算复杂度 | 低 | 中 | +30% |

### 7.2 适用场景

**增强特征集适合**：
- ✅ 数据质量高、字段完整
- ✅ 计算资源充足
- ✅ 追求更高预测精度
- ✅ 需要捕捉估值和市值因素

**基线特征集适合**：
- ✅ 快速验证模型架构
- ✅ 数据字段有限
- ✅ 计算资源有限
- ✅ 追求模型稳定性

---

## 八、总结

通过充分利用您提供的完整行业参数，增强特征集可以：

1. **捕捉更多信息**：价格、量能、估值、市值四个维度
2. **提高预测精度**：预期 Rank IC 提升 50%+
3. **增强模型鲁棒性**：多维度特征减少单一维度失效的风险

建议：
1. 先使用增强特征集训练模型
2. 通过 Feature Attention 权重分析特征重要性
3. 根据实际效果调整特征集（增加或减少特征）

