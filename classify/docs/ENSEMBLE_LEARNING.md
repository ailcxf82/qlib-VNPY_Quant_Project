# 集成学习（Ensemble Learning）功能说明

## 一、功能概述

`IndustryGRUWrapper` 现已支持集成学习模式，通过训练多个模型并取平均预测来降低方差，提升 ICIR（信息比率）。

### 核心原理

- **Bagging 策略**：训练多个模型，每个模型使用不同的随机种子初始化
- **平均预测**：对所有模型的预测结果取平均作为最终输出
- **降低方差**：通过集成多个模型的预测，减少单模型的波动，提升稳定性

---

## 二、配置方法

### 2.1 启用集成学习

在配置文件中添加 `num_ensemble` 参数：

```yaml
industry_gru_config:
  num_ensemble: 5  # 集成模型数量（默认 5）
  # 其他配置保持不变...
```

### 2.2 参数说明

- **`num_ensemble`**：
  - 默认值：`5`
  - 说明：集成模型的数量
  - 如果 `num_ensemble = 1`，则使用单模型模式（原有行为）
  - 如果 `num_ensemble > 1`，则启用集成学习模式

### 2.3 推荐配置

```yaml
industry_gru_config:
  num_ensemble: 5  # 5 个模型通常足够，更多模型收益递减
  sequence_length: 60
  hidden_size: 128
  num_layers: 2
  dropout: 0.15
  batch_size: 32
  lr: 0.001
  max_epochs: 100
  patience: 15
  # ... 其他配置
```

---

## 三、工作原理

### 3.1 训练过程

1. **循环训练 N 个模型**：
   - 每个模型使用不同的随机种子（`base_seed + i`）
   - 确保模型参数初始化和数据 shuffle 顺序不同

2. **随机种子设置**：
   ```python
   base_seed = 42
   for i in range(num_ensemble):
       seed = base_seed + i
       torch.manual_seed(seed)
       np.random.seed(seed)
       # 训练模型...
   ```

3. **独立训练**：
   - 每个模型独立训练，使用相同的训练数据
   - 但由于随机种子不同，模型参数和训练过程不同

### 3.2 预测过程

1. **所有模型预测**：
   - 对每个模型进行预测
   - 得到 N 个预测结果

2. **取平均**：
   ```python
   all_model_preds = [model1_pred, model2_pred, ..., modelN_pred]
   final_pred = np.mean(all_model_preds, axis=0)
   ```

### 3.3 保存/加载

- **保存**：
  - 集成模式：保存为 `{model_name}_industry_gru_ensemble.pt`
  - 单模型模式：保存为 `{model_name}_industry_gru.pt`

- **加载**：
  - 自动检测文件类型
  - 支持从集成模型和单模型互相加载（会给出警告）

---

## 四、使用示例

### 4.1 配置文件

```yaml
# config_industry_rotation.yaml
industry_gru_config:
  num_ensemble: 5  # 启用集成学习，5 个模型
  sequence_length: 60
  hidden_size: 128
  num_layers: 2
  dropout: 0.15
  batch_size: 32
  lr: 0.001
  max_epochs: 100
  patience: 15
  loss: "ranking"
  ranking_alpha: 0.8
```

### 4.2 训练日志示例

```
2026-01-03 10:00:00 - INFO - 启用集成学习模式，集成模型数量: 5
============================================================
[Ensemble] 训练模型 1/5...
============================================================
[Ensemble Model 1/5] Epoch 1/100: train_loss=0.123456, valid_loss=0.123456
[Ensemble Model 1/5] Epoch 10/100: train_loss=0.098765, valid_loss=0.098765
...
[Ensemble] 模型 1/5 训练完成，最佳验证损失: 0.098765
============================================================
[Ensemble] 训练模型 2/5...
============================================================
...
[Ensemble] 所有 5 个模型训练完成
============================================================
```

### 4.3 预测

```python
# 预测接口保持不变
pred = model.predict(valid_feat, history_feat=train_feat)
# 内部会自动对所有模型预测并取平均
```

---

## 五、性能影响

### 5.1 训练时间

- **训练时间**：约为单模型的 `N` 倍（N 为集成模型数量）
- **示例**：如果单模型训练需要 10 分钟，5 个模型需要约 50 分钟

### 5.2 预测时间

- **预测时间**：约为单模型的 `N` 倍
- **示例**：如果单模型预测需要 1 秒，5 个模型需要约 5 秒

### 5.3 内存占用

- **内存占用**：约为单模型的 `N` 倍
- **建议**：如果内存不足，可以减少 `num_ensemble` 或使用更小的模型

---

## 六、预期效果

### 6.1 降低方差

- **验证集 IC 标准差**：预期降低 20-40%
- **示例**：
  - 单模型：IC 均值 = 0.02，IC 标准差 = 0.10
  - 集成模型（5个）：IC 均值 = 0.02，IC 标准差 = 0.06-0.08

### 6.2 提升 ICIR

- **ICIR = IC 均值 / IC 标准差**
- **示例**：
  - 单模型：ICIR = 0.02 / 0.10 = 0.2
  - 集成模型：ICIR = 0.02 / 0.06 = 0.33（提升 65%）

### 6.3 稳定性提升

- **更稳定的预测**：减少极端预测值
- **更可靠的排名**：行业排名更稳定

---

## 七、注意事项

### 7.1 随机种子

- 每个模型使用不同的随机种子（`42 + i`）
- 确保模型多样性的关键

### 7.2 模型数量选择

- **推荐值**：5-10 个模型
- **太少**（< 3）：集成效果不明显
- **太多**（> 10）：训练时间过长，收益递减

### 7.3 兼容性

- **向后兼容**：`num_ensemble = 1` 时行为与原有代码完全一致
- **模型文件**：集成模型和单模型使用不同的文件格式，但可以互相识别

### 7.4 调试建议

- **先测试单模型**：确保单模型性能正常
- **再启用集成**：逐步增加 `num_ensemble`，观察效果
- **监控训练时间**：确保训练时间可接受

---

## 八、故障排查

### 8.1 训练失败

**问题**：某个模型训练失败

**解决**：
- 检查日志，查看具体错误
- 可能是内存不足，尝试减少 `num_ensemble` 或 `batch_size`

### 8.2 预测不一致

**问题**：集成预测结果与单模型差异很大

**解决**：
- 检查所有模型是否都成功训练
- 检查预测时是否所有模型都参与

### 8.3 加载失败

**问题**：加载模型时出错

**解决**：
- 检查文件路径是否正确
- 检查配置文件中的 `num_ensemble` 是否与保存的模型数量一致

---

## 九、总结

### 9.1 优势

- ✅ **降低方差**：减少预测波动
- ✅ **提升 ICIR**：提高信息比率
- ✅ **更稳定**：预测结果更可靠
- ✅ **向后兼容**：不影响现有代码

### 9.2 劣势

- ❌ **训练时间长**：需要训练多个模型
- ❌ **内存占用大**：需要存储多个模型
- ❌ **预测时间长**：需要运行多个模型

### 9.3 适用场景

- ✅ 验证集 IC 标准差较大（> 0.10）
- ✅ 需要提升 ICIR
- ✅ 训练时间可接受
- ✅ 有足够的计算资源

---

## 十、快速开始

1. **修改配置**：
   ```yaml
   industry_gru_config:
     num_ensemble: 5
   ```

2. **运行训练**：
   ```bash
   python classify/run_industry_train.py --config classify/config_industry_rotation.yaml
   ```

3. **观察效果**：
   - 查看验证集 IC 标准差是否降低
   - 查看 ICIR 是否提升

---

## 十一、相关文件

- **模型实现**：`classify/pytorch_industry_gru.py`
- **训练脚本**：`classify/run_industry_train.py`
- **配置文件**：`classify/config_industry_rotation.yaml`

